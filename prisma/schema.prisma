generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  name           String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  locatorProfile LocatorProfile?
  magicLinks     MagicLink[]
  sessions       QuizSession[]
  shareLinks     ShareLink[]

  @@index([email])
}

model MagicLink {
  id        String    @id @default(cuid())
  token     String    @unique
  email     String
  userId    String?
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email])
}

model ShareLink {
  id        String      @id @default(cuid())
  shareId   String      @unique @default(cuid())
  sessionId String
  userId    String
  showTopN  Int         @default(3)
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  session   QuizSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([shareId])
  @@index([sessionId])
}

model Neighborhood {
  id                  String             @id @default(cuid())
  name                String             @unique
  slug                String             @unique
  tier                Int
  infrastructureScore Float              @default(0)
  safetyScore         Float              @default(0)
  livabilityScore     Float              @default(0)
  trajectoryScore     Float              @default(0)
  sentimentScore      Float              @default(0)
  compositeScore      Float              @default(0)
  grade               String             @default("B")
  walkScore           Int?
  transitScore        Int?
  bikeScore           Int?
  medianRent          Int?
  rentMin             Int?
  rentMax             Int?
  boundary            Json?
  centerLat           Float
  centerLng           Float
  description         String?
  warnings            String[]
  highlights          String[]
  characterTags       String[]
  tagline             String?
  civicInsights       String?
  heroImage           String?
  thumbImage          String?
  sentimentSummary    String?
  lifestyleSummary    String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  ageDemoHigh         Int?
  ageDemoLow          Int?
  avoidArchetypes     String[]
  bestArchetypes      String[]
  commuteUptownMin    Int?
  nightlifeScore      Float              @default(0)
  priceScore          Float              @default(0)
  transitAccess       String?
  apartmentListings   ApartmentListing[]
  buildings           Building[]
  lifestyleVenues     LifestyleVenue[]
  quizResults         QuizResult[]
  sentimentQuotes     SentimentQuote[]
}

model SentimentQuote {
  id             String       @id @default(cuid())
  neighborhoodId String
  source         String
  content        String
  sentiment      String
  theme          String?
  postUrl        String?
  postId         String?
  author         String?
  subreddit      String?
  upvotes        Int?
  postDate       DateTime?
  createdAt      DateTime     @default(now())
  neighborhood   Neighborhood @relation(fields: [neighborhoodId], references: [id], onDelete: Cascade)

  @@index([neighborhoodId])
}

model QuizSession {
  id              String       @id @default(cuid())
  budgetMin       Int
  budgetMax       Int
  priorities      String[]
  vibes           String[]
  workAddress     String?
  maxCommute      Int?
  ageBracket      String?
  bedrooms        String?
  bathrooms       String?
  hasKids         Boolean      @default(false)
  hasDog          Boolean      @default(false)
  moveStatus      String?
  transportation  String?
  additionalNotes String?
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  utmTerm         String?
  utmContent      String?
  referrer        String?
  userId          String?
  paid            Boolean      @default(false)
  stripeSessionId String?      @unique
  stripePaymentId String?
  email           String?
  createdAt       DateTime     @default(now())
  expiresAt       DateTime?
  results         QuizResult[]
  user            User?        @relation(fields: [userId], references: [id])
  shareLinks      ShareLink[]

  @@index([stripeSessionId])
  @@index([userId])
  @@index([email])
}

model QuizResult {
  id             String       @id @default(cuid())
  sessionId      String
  neighborhoodId String
  matchScore     Float
  rank           Int
  createdAt      DateTime     @default(now())
  neighborhood   Neighborhood @relation(fields: [neighborhoodId], references: [id], onDelete: Cascade)
  session        QuizSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([neighborhoodId])
}

model Waitlist {
  id        String   @id @default(cuid())
  email     String
  city      String
  createdAt DateTime @default(now())

  @@unique([email, city])
}

model LifestyleVenue {
  id             String       @id @default(cuid())
  neighborhoodId String
  name           String
  category       String
  subcategory    String?
  address        String?
  rating         Float?
  priceLevel     Int?
  description    String?
  googlePlaceId  String?
  yelpId         String?
  lat            Float?
  lng            Float?
  photoUrl       String?
  photoRef       String?
  isHighlight    Boolean      @default(false)
  tags           String[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  neighborhood   Neighborhood @relation(fields: [neighborhoodId], references: [id], onDelete: Cascade)

  @@index([neighborhoodId])
  @@index([category])
}

model ApartmentListing {
  id                 String       @id @default(cuid())
  neighborhoodId     String
  name               String
  address            String
  description        String?
  rentMin            Int
  rentMax            Int
  bedrooms           String[]
  bathrooms          Float?
  sqftMin            Int?
  sqftMax            Int?
  amenities          String[]
  petPolicy          String?
  parkingType        String?
  rating             Float?
  reviewCount        Int?
  walkScore          Int?
  transitScore       Int?
  lat                Float
  lng                Float
  photoUrl           String?
  photos             String[]
  rentCastId         String?      @unique
  googlePlaceId      String?
  listingUrl         String?
  managementCompany  String?
  isGreystar         Boolean      @default(false)
  greystarConfidence String?
  floorplansUrl      String?
  greystarDetectedAt DateTime?
  source             String       @default("rentcast")
  isAvailable        Boolean      @default(true)
  isHighlight        Boolean      @default(false)
  tags               String[]
  lastSyncedAt       DateTime?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  neighborhood       Neighborhood @relation(fields: [neighborhoodId], references: [id], onDelete: Cascade)

  @@index([neighborhoodId])
  @@index([rentMin, rentMax])
  @@index([isAvailable])
}

model ManagementCompany {
  id             String     @id @default(cuid())
  name           String     @unique
  slug           String     @unique
  website        String?
  logoUrl        String?
  scrapeStrategy String?
  lastScrapedAt  DateTime?
  scrapeStatus   String     @default("active")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  buildings      Building[]

  @@index([slug])
}

model Building {
  id              String                @id @default(cuid())
  managementId    String?
  neighborhoodId  String
  name            String
  address         String
  city            String                @default("Charlotte")
  state           String                @default("NC")
  zipCode         String?
  lat             Float
  lng             Float
  googlePlaceId   String?
  rating          Float?
  reviewCount     Int?
  website         String?
  phone           String?
  primaryPhotoUrl String?
  photos          String[]
  amenities       String[]
  petPolicy       String?
  parkingType     String?
  listingUrl      String?
  floorplansUrl   String?
  yearBuilt       Int?
  totalUnits      Int?
  isAvailable     Boolean               @default(true)
  lastSyncedAt    DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  management      ManagementCompany?    @relation(fields: [managementId], references: [id])
  neighborhood    Neighborhood          @relation(fields: [neighborhoodId], references: [id], onDelete: Cascade)
  savedToClients  ClientSavedBuilding[]
  fieldEdits      FieldEdit[]
  specials        Special[]
  units           Unit[]

  @@unique([managementId, address])
  @@index([neighborhoodId])
  @@index([lat, lng])
  @@index([isAvailable])
}

model Special {
  id            String    @id @default(cuid())
  buildingId    String
  unitId        String?
  provider      String
  title         String
  description   String
  discountType  String?
  discountValue Float?
  conditions    String?
  startDate     DateTime?
  endDate       DateTime?
  sourceUrl     String
  rawHtml       String?
  scrapedAt     DateTime  @default(now())
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  building      Building  @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  unit          Unit?     @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([buildingId])
  @@index([unitId])
  @@index([provider])
  @@index([isActive])
  @@index([endDate])
}

model Unit {
  id             String               @id @default(cuid())
  buildingId     String
  unitNumber     String?
  name           String?
  bedrooms       Int
  bathrooms      Float
  sqftMin        Int?
  sqftMax        Int?
  rentMin        Int
  rentMax        Int
  availableCount Int                  @default(0)
  availableDate  DateTime?
  photoUrl       String?
  rentCastId     String?              @unique
  rentCastData   Json?
  isAvailable    Boolean              @default(true)
  lastSyncedAt   DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  clientNotes    ClientListingNote[]
  savedByClients ClientSavedListing[]
  fieldEdits     FieldEdit[]
  specials       Special[]
  building       Building             @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  @@index([buildingId])
  @@index([bedrooms])
  @@index([rentCastId])
  @@index([rentMin, rentMax])
  @@index([isAvailable, bedrooms, rentMin])
  @@index([isAvailable, rentMin, rentMax])
}

model ClientSavedBuilding {
  id          String        @id @default(cuid())
  clientId    String
  buildingId  String
  notes       String?
  matchScore  Float?
  matchReason String?
  createdAt   DateTime      @default(now())
  building    Building      @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  client      LocatorClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, buildingId])
  @@index([clientId])
  @@index([buildingId])
}

model ClientSavedListing {
  id        String        @id @default(cuid())
  clientId  String
  unitId    String
  notes     String?
  createdAt DateTime      @default(now())
  client    LocatorClient @relation(fields: [clientId], references: [id], onDelete: Cascade)
  unit      Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([clientId, unitId])
  @@index([clientId])
  @@index([unitId])
}

model LocatorProfile {
  id                   String              @id @default(cuid())
  userId               String              @unique
  passwordHash         String
  companyName          String?
  companyLogo          String?
  phone                String?
  stripeCustomerId     String?             @unique
  stripeSubscriptionId String?             @unique
  subscriptionStatus   String              @default("trialing")
  trialEndsAt          DateTime?
  currentPeriodEnd     DateTime?
  creditsRemaining     Int                 @default(50)
  creditsResetAt       DateTime?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  intakeSlug           String?             @unique
  intakeEnabled        Boolean             @default(true)
  intakeWelcomeMsg     String?
  listingNotes         ClientListingNote[]
  creditLedger         CreditLedger[]
  fieldEdits           FieldEdit[]
  clients              LocatorClient[]
  user                 User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  comparisons          ProComparison[]
  reports              ProReport[]
  savedSearches        ProSavedSearch[]

  @@index([stripeCustomerId])
  @@index([subscriptionStatus])
  @@index([intakeSlug])
}

model LocatorClient {
  id                String                @id @default(cuid())
  locatorId         String
  name              String
  email             String?
  phone             String?
  notes             String?
  status            String                @default("active")
  budgetMin         Int?
  budgetMax         Int?
  bedrooms          String[]
  neighborhoods     String[]
  amenities         String[]
  moveInDate        DateTime?
  vibes             String[]
  priorities        String[]
  hasDog            Boolean               @default(false)
  hasCat            Boolean               @default(false)
  hasKids           Boolean               @default(false)
  worksFromHome     Boolean               @default(false)
  needsParking      Boolean               @default(false)
  commuteAddress    String?
  commutePreference String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  source            String?
  intakeRef         String?
  contactPreference String?
  listingNotes      ClientListingNote[]
  savedBuildings    ClientSavedBuilding[]
  savedListings     ClientSavedListing[]
  shareReports      ClientShareReport[]
  locator           LocatorProfile        @relation(fields: [locatorId], references: [id], onDelete: Cascade)
  reports           ProReport[]

  @@index([locatorId])
  @@index([status])
}

model ClientShareReport {
  id           String        @id @default(cuid())
  shareId      String        @unique @default(cuid())
  clientId     String
  clientName   String
  preferences  Json
  listings     Json
  viewCount    Int           @default(0)
  lastViewedAt DateTime?
  expiresAt    DateTime?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  client       LocatorClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, shareId])
  @@index([shareId])
}

model CreditLedger {
  id        String         @id @default(cuid())
  locatorId String
  action    String
  amount    Int
  balance   Int
  metadata  Json?
  createdAt DateTime       @default(now())
  locator   LocatorProfile @relation(fields: [locatorId], references: [id], onDelete: Cascade)

  @@index([locatorId])
  @@index([createdAt])
}

model ProSavedSearch {
  id        String         @id @default(cuid())
  locatorId String
  name      String
  filters   Json
  newCount  Int            @default(0)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  locator   LocatorProfile @relation(fields: [locatorId], references: [id], onDelete: Cascade)

  @@index([locatorId])
}

model ProComparison {
  id          String         @id @default(cuid())
  locatorId   String
  name        String?
  propertyIds String[]
  notes       String?
  createdAt   DateTime       @default(now())
  locator     LocatorProfile @relation(fields: [locatorId], references: [id], onDelete: Cascade)

  @@index([locatorId])
}

model ProReport {
  id               String               @id @default(cuid())
  locatorId        String
  clientId         String?
  title            String
  propertyIds      String[]
  buildingIds      String[]
  neighborhoodIds  String[]
  customNotes      String?
  aiSummary        String?
  shareToken       String               @unique @default(cuid())
  isPublic         Boolean              @default(true)
  viewCount        Int                  @default(0)
  pdfUrl           String?
  createdAt        DateTime             @default(now())
  clientBudget     String?
  clientMoveDate   String?
  clientPriorities String[]
  locatorName      String?
  publishedAt      DateTime?
  client           LocatorClient?       @relation(fields: [clientId], references: [id])
  locator          LocatorProfile       @relation(fields: [locatorId], references: [id], onDelete: Cascade)
  neighborhoods    ReportNeighborhood[]
  properties       ReportProperty[]

  @@index([locatorId])
  @@index([clientId])
  @@index([shareToken])
}

model ReportProperty {
  id            String               @id @default(cuid())
  reportId      String
  buildingId    String?
  unitId        String?
  name          String
  address       String
  neighborhood  String
  imageUrl      String?
  rent          Int
  bedrooms      Int
  bathrooms     Float
  sqft          Int?
  availableDate String?
  amenities     String[]
  walkScore     Int?
  isRecommended Boolean              @default(false)
  locatorNote   String?
  sortOrder     Int                  @default(0)
  deposit       Int?
  adminFee      Int?
  petDeposit    Int?
  petRent       Int?
  promos        String?
  createdAt     DateTime             @default(now())
  report        ProReport            @relation(fields: [reportId], references: [id], onDelete: Cascade)
  notes         ReportPropertyNote[]

  @@index([reportId])
}

model ReportNeighborhood {
  id             String    @id @default(cuid())
  reportId       String
  neighborhoodId String?
  name           String
  vibe           String?
  walkability    String?
  safety         String?
  dogFriendly    String?
  sortOrder      Int       @default(0)
  createdAt      DateTime  @default(now())
  report         ProReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
}

model ClientListingNote {
  id              String         @id @default(cuid())
  clientId        String
  unitId          String
  locatorId       String
  type            String
  content         String
  visibleToClient Boolean        @default(true)
  sortOrder       Int            @default(0)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  client          LocatorClient  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  locator         LocatorProfile @relation(fields: [locatorId], references: [id], onDelete: Cascade)
  unit            Unit           @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([clientId, unitId])
  @@index([locatorId])
}

model ReportPropertyNote {
  id         String         @id @default(cuid())
  propertyId String
  type       String
  content    String
  sortOrder  Int            @default(0)
  createdAt  DateTime       @default(now())
  property   ReportProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
}

model FieldEdit {
  id            String          @id @default(cuid())
  unitId        String?
  buildingId    String?
  fieldName     String
  previousValue Json?
  newValue      Json
  source        String          @default("locator")
  editedById    String?
  hasConflict   Boolean         @default(false)
  conflictValue Json?
  createdAt     DateTime        @default(now())
  building      Building?       @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  editedBy      LocatorProfile? @relation(fields: [editedById], references: [id])
  unit          Unit?           @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId, fieldName, createdAt(sort: Desc)])
  @@index([buildingId, fieldName, createdAt(sort: Desc)])
  @@index([hasConflict])
}
